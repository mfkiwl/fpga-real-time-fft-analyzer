<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFT Analyzer with Filter Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .control-group h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-inline {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .form-inline .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.active {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.inactive {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .plot-container {
            margin: 20px 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }
        .frequency-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .single-column {
            grid-column: 1 / -1;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .modal-header h2 {
            margin: 0;
            color: #495057;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }
        .filter-plot-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .filter-plot-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .coefficients-display {
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.4;
        }
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }
        .coefficients-note {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FFT Analyzer with Filter Generator</h1>
            <div id="status" class="status inactive">
                Disconnected
            </div>
        </div>

        <div class="controls">
            <!-- Existing FFT Controls -->
            <div class="control-group">
                <h3>FFT Analyzer Controls</h3>
                
                <div class="form-group">
                    <label>Communication Mode:</label>
                    <select id="commMode">
                        <option value="UART">UART</option>
                        <option value="ETHERNET">Ethernet</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Plot Types:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="plotMagnitude" checked> Magnitude</label>
                        <label><input type="checkbox" id="plotReal"> Real</label>
                        <label><input type="checkbox" id="plotImaginary"> Imaginary</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Frequency Range (KHz):</label>
                    <div class="frequency-inputs">
                        <input type="number" id="freqStart" min="0" max="1000" step="0.1" value="0" placeholder="Start">
                        <input type="number" id="freqEnd" min="0" max="1000" step="0.1" value="1000" placeholder="End">
                    </div>
                </div>

                <!-- Filter Type Selection -->
                <div class="form-group">
                    <label>Active Filter:</label>
                    <div class="form-inline">
                        <div class="form-group">
                            <select id="activeFilterSelect">
                                <option value="default">Default Filter</option>
                                <option value="custom">Custom Filter</option>
                                <option value="none">No Filter</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="setFilterType()">Apply Filter</button>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="setMode()">Set Mode</button>
                    <button class="btn btn-success" onclick="startReceiver()">Start</button>
                    <button class="btn btn-warning" onclick="stopReceiver()">Stop</button>
                    <button class="btn btn-danger" onclick="fpgaReset()">FPGA Reset</button>
                    <button class="btn btn-primary" onclick="applyFrequencyRange()">Apply Range</button>
                    <button class="btn btn-warning" onclick="resetPlot()">Reset Plot</button>
                </div>
            </div>

            <!-- Filter Generator Controls -->
            <div class="control-group">
                <h3>Filter Generator</h3>

                                <!-- New design-method row -->
                <div class="form-group">
                <label>Design Method:</label>
                <select id="filterKind">
                    <option value="butter">Butterworth</option>
                    <option value="cheby1">Chebyshev I</option>
                    <option value="cheby2">Chebyshev II</option>
                    <option value="ellip">Elliptic</option>
                    <option value="bessel">Bessel</option>
                </select>
                </div>

                <!-- Optional ripple (pass-band) -->
                <div class="form-group">
                <label>Ripple&nbsp;dB (Cheb I / Ellip):</label>
                <input type="number" id="ripple" min="0.1" max="5" step="0.1" value="1">
                </div>

                <!-- Optional attenuation (stop-band) -->
                <div class="form-group">
                <label>Attenuation&nbsp;dB (Cheb II / Ellip):</label>
                <input type="number" id="attenuation" min="20" max="120" step="1" value="40">
                </div>

                
                <div class="form-group">
                    <label>Filter Type:</label>
                    <select id="filterType">
                        <option value="lowpass">Low Pass</option>
                        <option value="highpass">High Pass</option>
                        <option value="bandpass">Band Pass</option>
                        <option value="bandstop">Band Stop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Filter Order:</label>
                    <select id="filterOrder">
                        <option value="2">2nd Order</option>
                        <option value="4" selected>4th Order</option>
                        <option value="6">6th Order</option>
                        <option value="8">8th Order</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Sample Rate (MHz):</label>
                    <input type="number" id="sampleRate" min="1" max="1000" step="0.1" value="100">
                </div>

                <div class="form-group">
                    <label>Cutoff Frequency (MHz):</label>
                    <input type="number" id="cutoffFreq" min="0.1" max="500" step="0.1" value="10">
                </div>

                <div class="form-group" id="cutoffFreq2Group" style="display: none;">
                    <label>Second Cutoff (MHz):</label>
                    <input type="number" id="cutoffFreq2" min="0.1" max="500" step="0.1" value="20">
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="generateFilterPreview()">Generate Preview</button>
                    <button class="btn btn-info" onclick="showFilterPreview()" disabled id="viewPreviewBtn">View Preview</button>
                    <button class="btn btn-success" onclick="applyFilterToFPGA()" disabled id="applyFilterBtn">Apply to FPGA</button>
                </div>
            </div>
        </div>

        <!-- FFT Plot -->
        <div class="plot-container">
            <div id="fftPlot" style="height: 400px;"></div>
        </div>

        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="incomingFPS">0.0</div>
                <div class="stat-label">Incoming FPS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="displayFPS">0.0</div>
                <div class="stat-label">Display FPS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="framesReceived">0</div>
                <div class="stat-label">Frames Received</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="framesDropped">0</div>
                <div class="stat-label">Frames Dropped</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="peakFreq">0.0</div>
                <div class="stat-label">Peak Frequency (KHz)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="peakMagnitude">0.0</div>
                <div class="stat-label">Peak Magnitude</div>
            </div>
        </div>
    </div>

    <!-- Filter Preview Modal -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Filter Response Preview</h2>
                <span class="close" onclick="closeFilterModal()">&times;</span>
            </div>

            <div class="filter-plot-container">
                <div id="modalFilterPlot">
                    <p>No filter preview generated yet. Click "Generate Preview" first.</p>
                </div>
            </div>

            <div class="coefficients-note">
                <strong>Note:</strong> Coefficients are unnormalized and scaled by 64 for 8-bit FPGA implementation. 
                What you see here is exactly what gets sent to the FPGA.
            </div>

            <div id="modalCoefficientsDisplay" class="coefficients-display" style="display: none;"></div>

            <div class="modal-footer">
                <button class="btn btn-success" onclick="applyFilterToFPGA()" disabled id="modalApplyBtn">Apply to FPGA</button>
                <button class="btn btn-primary" onclick="closeFilterModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize socket connection
        const socket = io();
        let currentConfig = {};
        let lastPlotData = null;
        let filterPreviewData = null;

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('config_update', function(data) {
            currentConfig = data;
            updateUIFromConfig();
        });

        socket.on('receiver_status', function(data) {
            updateStatus(data);
        });

        socket.on('frame_data', function(data) {
            lastPlotData = data;
            updatePlot(data);
            updateStats(data);
        });

        socket.on('filter_preview', function(data) {
            filterPreviewData = data;
            updateFilterPreview(data);
        });

        socket.on('plot_reset', function(data) {
            clearPlot();
        });

        // UI update functions
        function updateUIFromConfig() {
            document.getElementById('commMode').value = currentConfig.comm_mode || 'UART';
            document.getElementById('freqStart').value = currentConfig.freq_range_start || 0;
            document.getElementById('freqEnd').value = currentConfig.freq_range_end || 1000;
            
            // Update plot type checkboxes
            const plotTypes = currentConfig.plot_types || ['magnitude'];
            document.getElementById('plotMagnitude').checked = plotTypes.includes('magnitude');
            document.getElementById('plotReal').checked = plotTypes.includes('real');
            document.getElementById('plotImaginary').checked = plotTypes.includes('imaginary');

            // Update filter config
            document.getElementById('filterType').value = currentConfig.filter_type || 'lowpass';
            document.getElementById('filterOrder').value = currentConfig.filter_order || 4;
            document.getElementById('cutoffFreq').value = currentConfig.cutoff_freq || 10;
            document.getElementById('cutoffFreq2').value = currentConfig.cutoff_freq2 || 20;
            document.getElementById('sampleRate').value = currentConfig.sample_rate || 100;
            
            // Update active filter selection
            document.getElementById('activeFilterSelect').value = currentConfig.active_filter || 'default';
            
            updateFilterTypeVisibility();
        }

        function updateStatus(data) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = data.message;
            statusElement.className = data.active ? 'status active' : 'status inactive';
        }

        function updatePlot(data) {
            const traces = [];
            
            if (data.data.magnitude) {
                traces.push({
                    x: data.frequency,
                    y: data.data.magnitude,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Magnitude',
                    line: { color: 'blue' }
                });
            }
            
            if (data.data.real) {
                traces.push({
                    x: data.frequency,
                    y: data.data.real,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Real',
                    line: { color: 'red' }
                });
            }
            
            if (data.data.imaginary) {
                traces.push({
                    x: data.frequency,
                    y: data.data.imaginary,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Imaginary',
                    line: { color: 'green' }
                });
            }

            const layout = {
                title: 'FFT Spectrum Analysis',
                xaxis: { title: 'Frequency (KHz)' },
                yaxis: { title: 'Magnitude' },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };

            Plotly.newPlot('fftPlot', traces, layout, {responsive: true});
        }

        function updateStats(data) {
            document.getElementById('incomingFPS').textContent = data.incoming_fps;
            document.getElementById('displayFPS').textContent = data.display_fps;
            document.getElementById('framesReceived').textContent = data.frames_received;
            document.getElementById('framesDropped').textContent = data.frames_dropped;
            document.getElementById('peakFreq').textContent = (data.peak_frequency).toFixed(3);
            document.getElementById('peakMagnitude').textContent = data.peak_magnitude.toFixed(1);
        }

        function clearPlot() {
            Plotly.newPlot('fftPlot', [], {
                title: 'FFT Spectrum Analysis',
                xaxis: { title: 'Frequency (KHz)' },
                yaxis: { title: 'Magnitude' }
            });
        }

        function updateFilterPreview(data) {
            const viewBtn      = document.getElementById('viewPreviewBtn');
            const applyBtn     = document.getElementById('applyFilterBtn');
            const modalApplyBtn= document.getElementById('modalApplyBtn');

            if (!data.success) {
                viewBtn.disabled = applyBtn.disabled = modalApplyBtn.disabled = true;
                alert('Filter generation failed: ' + (data.error || 'Unknown error'));
                return;
            }

            viewBtn.disabled = applyBtn.disabled = modalApplyBtn.disabled = false;

            /* ---------- Plot ---------- */
            if (data.plot_url) {
                document.getElementById('modalFilterPlot').innerHTML =
                    `<img src="${data.plot_url}" alt="Filter Response">`;
            }

            /* ---------- Coefficient list ---------- */
            let coeffs = data.coefficients;

            /* 1. Handle any flattened or string-based payloads -------------------- */
            if (coeffs.length && typeof coeffs[0] === 'string') {
                coeffs = coeffs.map(str => str.split(',').map(v => parseInt(v.trim(), 10)));
            } else if (!(Array.isArray(coeffs) && coeffs.length === 6) &&
                    coeffs.length % 6 === 0) {
                /* Flattened numeric array → reshape into 6-element sections */
                const reshaped = [];
                for (let i = 0; i < coeffs.length; i += 6) {
                    reshaped.push(coeffs.slice(i, i + 6));
                }
                coeffs = reshaped;
            }

            /* 2. Render text ------------------------------------------------------- */
            let txt = `Filter Coefficients (${coeffs.length} sections):\n`;
            txt += 'Unnormalized, scaled by 64, 8-bit signed (-128 to 127)\n\n';

            coeffs.forEach((sec, idx) => {
                if (!Array.isArray(sec) || sec.length !== 6) {
                    txt += `Section ${idx}: ERROR – invalid format\n\n`;
                    return;
                }
                txt += `Section ${idx}:\n`;
                txt += `  B0=${sec[0]}, B1=${sec[1]}, B2=${sec[2]}\n`;
                txt += `  A0=${sec[3]}, A1=${sec[4]}, A2=${sec[5]}\n\n`;
            });

            if (data.note) txt += `Note: ${data.note}\n`;

            const display = document.getElementById('modalCoefficientsDisplay');
            display.textContent = txt;
            display.style.display = 'block';
        }





        function updateFilterTypeVisibility() {
            const filterType = document.getElementById('filterType').value;
            const cutoffFreq2Group = document.getElementById('cutoffFreq2Group');
            
            if (filterType == 'bandpass' || filterType == 'bandstop') {
                cutoffFreq2Group.style.display = 'block';
            } else {
                cutoffFreq2Group.style.display = 'none';
            }
        }

        // Modal functions
        function showFilterPreview() {
            if (filterPreviewData && filterPreviewData.success) {
                document.getElementById('filterModal').style.display = 'block';
            } else {
                alert('No filter preview available. Generate a preview first.');
            }
        }

        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('filterModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Control functions
        function setMode() {
            const mode = document.getElementById('commMode').value;
            socket.emit('update_config', { comm_mode: mode });
            socket.emit('set_mode');
        }

        function startReceiver() {
            socket.emit('start_receiver');
        }

        function stopReceiver() {
            socket.emit('stop_receiver');
        }

        function fpgaReset() {
            socket.emit('fpga_reset');
        }

        function resetPlot() {
            socket.emit('reset_plot');
        }

        function applyFrequencyRange() {
            const freqStart = parseFloat(document.getElementById('freqStart').value);
            const freqEnd = parseFloat(document.getElementById('freqEnd').value);
            
            const plotTypes = [];
            if (document.getElementById('plotMagnitude').checked) plotTypes.push('magnitude');
            if (document.getElementById('plotReal').checked) plotTypes.push('real');
            if (document.getElementById('plotImaginary').checked) plotTypes.push('imaginary');
            
            socket.emit('apply_frequency_range', {
                freq_start: freqStart,
                freq_end: freqEnd,
                plot_types: plotTypes
            });
        }

        // Filter type selection function
        function setFilterType() {
            const filterOption = document.getElementById('activeFilterSelect').value;
            socket.emit('set_filter_type', {
                filter_option: filterOption
            });
        }

        // Filter generator functions
        function generateFilterPreview() {
                const filterConfig = {
                filter_type:  document.getElementById("filterType").value,
                filter_order: parseInt(document.getElementById("filterOrder").value),
                cutoff_freq:  parseFloat(document.getElementById("cutoffFreq").value),
                cutoff_freq2: parseFloat(document.getElementById("cutoffFreq2").value),
                sample_rate:  parseFloat(document.getElementById("sampleRate").value),
                filter_kind:  document.getElementById("filterKind").value,
                ripple:       parseFloat(document.getElementById("ripple").value),
                attenuation:  parseFloat(document.getElementById("attenuation").value)
                };

            
            socket.emit('update_filter_config', filterConfig);
            socket.emit('generate_filter_preview');
        }

        function applyFilterToFPGA() {
            if (confirm('Apply current filter design to FPGA?\n\nThe exact coefficients shown above will be sent to the FPGA.')) {
                socket.emit('apply_filter_to_fpga');
                closeFilterModal(); // Close modal after applying
            }
        }

        // Real-time plot type update function
        function updatePlotTypes() {
            applyFrequencyRange();
        }

        // Event listeners
        document.getElementById('filterType').addEventListener('change', updateFilterTypeVisibility);
        
        // Add real-time plot type listeners
        document.getElementById('plotMagnitude').addEventListener('change', updatePlotTypes);
        document.getElementById('plotReal').addEventListener('change', updatePlotTypes);
        document.getElementById('plotImaginary').addEventListener('change', updatePlotTypes);

        // Initialize UI
        updateFilterTypeVisibility();
    </script>
</body>
</html>
